<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
</head>
<body>
  <div id="app">
    <v-app>
      <v-main>
        <v-container style="top:50vh;left:50%;position:absolute;transform:translate(-50%,-50%)">
          <template v-if="status=='before-start'" >
            <v-alert
              border="top"
              color="yellow"
              >
              Maintenance window will open in {{clock_text}}
            </alert>
          </template>
          <template v-else-if="status=='window-open'" >
            <v-alert
              border="top"
              color="green"
              dark
              >
              Maintenance window open!  Will close in {{clock_text}}
            </alert>
          </template>
          <template v-else-if="status=='window-closed'" >
            <v-alert
              border="top"
              color="red"
              dark
              >
              Maintenance window closed.
            </alert>
          </template>
          <template v-else >
            <v-alert
              border="top"
              color="blue-grey"
              dark
              >
              Maintenance countdown.  To use this page, create a URL like: <tt>{{url}}#start=&lt;start-time&gt;&amp;end=&lt;end_time&gt;</tt>
            </alert>
          </template>
        </v-container>
      </v-main>
    </v-app>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <script>
    new Vue({
      el: '#app',
      vuetify: new Vuetify(),
        data: () => ({
            start: 0,
            end: 0,
            status: '',
            time_to_next_event: 0,
            url: location.href.replace(/#.*/,''),
            interval: null,
        }),
        mounted() {
            this.get_times();
            window.addEventListener('hashchange', () => this.get_times(), false);
        },
        methods: {
            get_times() {
                const times = {};
                location.hash.replace( /(?:^#|\?|&)([^&]*)=([^&]*)/g, (_,key,value) => times[key] = value );
                try {
                    this.start = new Date( times.start ).getTime();
                } catch (e) {
                    this.start = 0;
                }
                try {
                    this.end = new Date( times.end ).getTime();
                } catch (e) {
                    this.end = 0;
                }
                if ( this.interval ) clearInterval(this.interval);
                if ( this.start && this.end ) {
                    this.update();
                    this.interval = setInterval( () => this.update(), 1000 );
                } else {
                    this.status = "usage";
                    this.interval = null;
                }
            },
            update() {
                const now = new Date().getTime();
                if ( now < this.start ) {
                    this.status = "before-start";
                    this.time_to_next_event = ( this.start - now ) / 1000;
                } else if ( now < this.end ) {
                    this.status = "window-open";
                    this.time_to_next_event = ( this.end - now ) / 1000;
                } else {
                    this.status = "window-closed";
                }
            },
        },
        computed: {
            clock_text() {
                return (
                    [
                        Math.floor( this.time_to_next_event / (60*60), ),
                        Math.floor( this.time_to_next_event / 60, ) % 60,
                        Math.floor( this.time_to_next_event ) % 60,
                    ].map( t => ( t < 10 ? '0' : '' ) + t )
                        .join(':')
                );
            },
        },
    })
  </script>
</body>
</html>
